# PPT 助手连接问知数据库配置说明

## 概述

PPT 助手现在可以直接使用问知的 PostgreSQL 数据库进行数据存储。问知使用 PostgreSQL 作为向量库，PPT 助手可以共享这个数据库。

问知只需要传递 `userCode` 参数给 PPT 助手即可。

## 配置步骤

### 1. 设置环境变量

在 PPT 助手项目的环境变量中，添加问知的 PostgreSQL 数据库连接配置：

```bash
# 使用问知的 PostgreSQL 数据库连接（问知用于向量库的 PostgreSQL）
# 格式：postgresql://username:password@host:port/database
# 示例（根据问知的 .env.template 配置）：
PG_URL=postgresql://username:password@10.221.24.71:65009/postgres
```

**注意：**
- PPT 助手会优先使用 `PG_URL` 环境变量（与问知使用相同的环境变量名）
- 如果设置了 `PG_URL`，PPT 助手将连接到问知的 PostgreSQL 数据库
- 如果未设置 `PG_URL`，PPT 助手将使用自己的数据库配置（`DATABASE_URL` 或默认 SQLite）
- 这样可以直接复用问知的数据库配置，无需额外配置

### 2. 数据库表结构

PPT 助手会在问知的数据库中自动创建以下表：
- `presentations` - 演示文稿主表
- `slides` - 幻灯片表
- `image_assets` - 图片资源表
- `key_value` - 键值对表
- `presentation_layout_codes` - 布局代码表
- `templates` - 模板表
- `webhook_subscriptions` - Webhook 订阅表
- `async_presentation_generation_tasks` - 异步任务表

这些表会在 PPT 助手启动时自动创建，不会影响问知现有的表结构。

### 3. 用户隔离

PPT 助手通过 `user_id` 字段（对应问知传递的 `userCode`）来区分不同用户的数据：
- 创建演示文稿时，会自动存储 `user_id`
- 查询演示文稿时，会根据 `userCode` 参数过滤数据
- 每个用户只能看到自己创建的 PPT

## 使用方式

### 从问知访问 PPT 助手

问知在 iframe 中加载 PPT 助手时，URL 格式为：
```
http://localhost:5000/?userCode={userInfo?.UserCode}
```

PPT 助手会自动：
1. 从 URL 参数中获取 `userCode`
2. 在创建演示文稿时存储 `userCode` 到 `user_id` 字段
3. 在 dashboard 中根据 `userCode` 过滤显示该用户的 PPT

## 注意事项

1. **数据库权限**：确保问知的 PostgreSQL 数据库用户有创建表和插入/查询/更新/删除数据的权限
2. **表名冲突**：PPT 助手使用的表名都是独立的，不会与问知现有的表冲突
3. **数据隔离**：不同用户的数据通过 `user_id` 字段完全隔离
4. **向后兼容**：如果未设置 `PG_URL`，PPT 助手会继续使用自己的数据库配置（`DATABASE_URL` 或默认 SQLite）
5. **环境变量优先级**：`PG_URL` > `DATABASE_URL` > 默认 SQLite
6. **环境变量共享**：PPT 助手使用与问知相同的 `PG_URL` 环境变量，可以直接共享配置

## 配置示例

### Docker 环境

在 `docker-compose.yml` 或环境变量文件中添加：

```yaml
environment:
  # 使用问知的 PostgreSQL 数据库连接
  - PG_URL=postgresql://username:password@10.221.24.71:65009/postgres
```

### 本地开发环境

在 `.env` 文件中添加（使用问知相同的配置）：

```bash
# 直接使用问知的 PG_URL 配置
PG_URL=postgresql://username:password@10.221.24.71:65009/postgres
```

**推荐方式：** 如果 PPT 助手和问知运行在同一环境中，可以直接共享 `PG_URL` 环境变量，无需重复配置。

## 验证配置

启动 PPT 助手后，检查日志中是否有数据库连接成功的消息。如果连接成功，PPT 助手会自动创建所需的表结构。

