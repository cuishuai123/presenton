# PPT 助手数据库问题排查指南

## 500 错误排查步骤

### 1. 检查数据库连接配置

确保 PPT 助手的环境变量中设置了正确的 `PG_URL`：

```bash
PG_URL=postgresql://username:password@10.221.24.71:65009/postgres
```

**验证方法：**
- 检查 PPT 助手启动日志，看是否有数据库连接错误
- 确认数据库地址、端口、用户名、密码是否正确
- 确认数据库服务是否正在运行

### 2. 检查数据库表结构

PPT 助手启动时会自动：
- 创建所需的表（如果不存在）
- 为现有的 `presentations` 表添加 `user_id` 列（如果不存在）

**验证方法：**
连接到 PostgreSQL 数据库，检查表结构：

```sql
-- 检查 presentations 表是否存在
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' AND table_name = 'presentations';

-- 检查 user_id 列是否存在
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'presentations' AND column_name = 'user_id';
```

如果 `user_id` 列不存在，可以手动添加：

```sql
ALTER TABLE presentations ADD COLUMN user_id VARCHAR;
```

### 3. 检查数据库权限

确保数据库用户有以下权限：
- CREATE TABLE（创建表）
- ALTER TABLE（修改表结构）
- INSERT, SELECT, UPDATE, DELETE（数据操作）

**验证方法：**
```sql
-- 检查当前用户权限
SELECT grantee, privilege_type 
FROM information_schema.role_table_grants 
WHERE table_name = 'presentations';
```

### 4. 查看后端日志

检查 PPT 助手后端服务的日志输出，查找：
- 数据库连接错误
- SQL 执行错误
- 表结构错误

**常见错误：**
- `relation "presentations" does not exist` - 表不存在
- `column "user_id" does not exist` - 列不存在
- `permission denied` - 权限不足
- `connection refused` - 数据库连接失败

### 5. 测试数据库连接

可以使用以下 Python 代码测试数据库连接：

```python
import asyncio
from sqlalchemy.ext.asyncio import create_async_engine
from sqlalchemy import text

async def test_connection():
    database_url = "postgresql+asyncpg://username:password@10.221.24.71:65009/postgres"
    engine = create_async_engine(database_url)
    
    async with engine.begin() as conn:
        result = await conn.execute(text("SELECT 1"))
        print("Database connection successful!")
        print(result.fetchone())
    
    await engine.dispose()

asyncio.run(test_connection())
```

### 6. 重启 PPT 助手服务

修改数据库配置后，需要重启 PPT 助手服务：
1. 停止当前服务
2. 确保环境变量已正确设置
3. 重新启动服务
4. 查看启动日志，确认数据库连接成功

### 7. 常见问题解决

**问题 1：表已存在但没有 user_id 列**
- 解决：PPT 助手启动时会自动添加，如果失败可以手动执行 SQL

**问题 2：数据库连接超时**
- 解决：检查网络连接、防火墙设置、数据库服务状态

**问题 3：权限不足**
- 解决：联系数据库管理员，授予必要的权限

**问题 4：数据库 URL 格式错误**
- 解决：确保 URL 格式为 `postgresql://username:password@host:port/database`

## 调试建议

1. **启用详细日志**：在 PPT 助手配置中启用 DEBUG 日志级别
2. **检查网络**：确保 PPT 助手服务器可以访问问知的 PostgreSQL 数据库
3. **测试连接**：使用 psql 或数据库客户端工具测试连接
4. **查看完整错误**：检查后端服务的完整错误堆栈，而不仅仅是 500 错误

## 联系支持

如果问题仍然存在，请提供：
1. 完整的错误日志
2. 数据库连接配置（隐藏密码）
3. 数据库表结构信息
4. PPT 助手版本信息

