# 使用国内镜像源的开发环境 Dockerfile
# 如果默认源不可用，使用此文件: docker-compose -f docker-compose.yml build --build-arg DOCKERFILE=Dockerfile.dev.cn development

# 使用 Docker Hub 官方镜像
# 如果拉取失败，可以尝试：
# 1. 配置 Docker daemon 使用国内镜像源（推荐）
# 2. 或者取消注释下面的阿里云镜像
# FROM registry.cn-hangzhou.aliyuncs.com/acs/python:3.11-slim-bookworm
FROM python:3.11-slim-bookworm

# 配置 Debian 使用国内镜像源（加速 apt 包下载）
RUN sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources 2>/dev/null || \
    sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list 2>/dev/null || \
    echo "镜像源配置失败，使用默认源" || true

# Install Node.js and npm (添加重试机制)
RUN for i in 1 2 3; do \
        apt-get update && break || sleep 5; \
    done && \
    apt-get install -y --no-install-recommends \
    nginx \
    curl \
    libreoffice \
    fontconfig \
    chromium \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js 20 using NodeSource repository (添加重试机制)
# 使用国内镜像加速
RUN for i in 1 2 3; do \
        curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && break || sleep 10; \
    done && \
    apt-get install -y nodejs && \
    node -v && npm -v && \
    rm -rf /var/lib/apt/lists/*

# 配置 npm 使用国内镜像源
RUN npm config set registry https://registry.npmmirror.com

# Change working directory
WORKDIR /app

# Set environment variables
ENV APP_DATA_DIRECTORY=/app_data
ENV TEMP_DIRECTORY=/tmp/presenton
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium
# 跳过 Puppeteer 的 Chromium 下载（因为已安装系统 Chromium）
ENV PUPPETEER_SKIP_DOWNLOAD=true
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true

# Install ollama (可选，如果需要可以取消注释)
# RUN curl -fsSL https://ollama.com/install.sh | sh

# Install dependencies for FastAPI (使用国内镜像源)
RUN pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple && \
    pip install --no-cache-dir --retries 3 --timeout 100 \
    aiohttp aiomysql aiosqlite asyncpg fastapi[standard] \
    pathvalidate pdfplumber chromadb sqlmodel \
    anthropic google-genai openai fastmcp dirtyjson && \
    pip install --no-cache-dir --retries 3 --timeout 100 \
    docling --extra-index-url https://download.pytorch.org/whl/cpu

# Copy necessary files (代码通过 volume 挂载，不需要复制)
COPY start.js package.json LICENSE NOTICE ./
COPY nginx.conf /etc/nginx/nginx.conf

# Expose the port
EXPOSE 80

# Start the servers (开发模式)
CMD ["node", "/app/start.js", "--dev"]
